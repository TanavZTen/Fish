<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Literature</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: #0a0e1a; color: #fff; min-height: 100vh; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .card { background: #1a1f2e; border: 1px solid #2a3142; border-radius: 12px; padding: 30px; margin: 20px 0; }
    h1 { color: #ffd700; text-align: center; font-size: 48px; margin-bottom: 10px; }
    input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #2a3142; background: #0a0e1a; color: #fff; font-size: 16px; }
    button { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; font-weight: 700; cursor: pointer; border: none; }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .team { background: #0a0e1a; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .team h3 { margin-bottom: 10px; }
    .player { background: #1a1f2e; padding: 10px; border-radius: 6px; margin: 5px 0; display: flex; justify-content: space-between; }
    .btn-sm { width: auto; padding: 6px 12px; font-size: 14px; }
    .t1 { color: #ef4444; }
    .t2 { color: #3b82f6; }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
    const DB = window.supabase.createClient(
      'https://vngdiukjrfmzwlbefmjf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuZ2RpdWtqcmZtendsYmVmbWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0Njk5MDUsImV4cCI6MjA4MzA0NTkwNX0.XBr7aEzSPj-Iw0HYf27T8yXo1nbZ01MhBVa-VIdNZG4'
    );
    
    const myId = localStorage.getItem('player-id') || (() => {
      const id = crypto.randomUUID();
      localStorage.setItem('player-id', id);
      return id;
    })();
    
    let state = { view: 'home', name: '', code: '', team: '', game: null };
    
    async function save(game) {
      try {
        console.log('Saving game to room:', state.code);
        console.log('Game data:', game);
        
        const { data: updateData, error: updateErr } = await DB.from('games')
          .update({ game_data: game, updated_at: new Date().toISOString() })
          .eq('room_code', state.code);
        
        console.log('Update error:', updateErr?.message || 'none');
        
        if (updateErr) {
          console.log('Update failed, trying insert...');
          const { data: insertData, error: insertErr } = await DB.from('games')
            .insert({ room_code: state.code, game_data: game });
          
          console.log('Insert error:', insertErr?.message || 'none');
          console.log('Insert error code:', insertErr?.code);
          console.log('Insert error details:', insertErr?.details);
          
          if (insertErr) {
            console.error('INSERT FAILED:', insertErr.message);
            return;
          }
        }
        
        console.log('Save successful!');
        state.game = game;
        render();
      } catch (e) {
        console.error('Save exception:', e.message);
      }
    }
    
    async function load() {
      if (!state.code) return;
      try {
        const { data, error } = await DB.from('games').select('*').eq('room_code', state.code).maybeSingle();
        if (error) {
          console.error('Load error:', error.message);
          return;
        }
        if (data) {
          state.game = data.game_data;
          render();
        }
      } catch (e) {
        console.error('Load exception:', e.message);
      }
    }
    
    function createRoom() {
      if (!state.name) return alert('Enter your name');
      state.code = Math.random().toString(36).substr(2, 6).toUpperCase();
      state.view = 'team';
      render();
    }
    
    async function joinRoom() {
      if (!state.name || !state.code) return alert('Enter name and code');
      state.code = state.code.toUpperCase().trim();
      
      try {
        console.log('Trying to join room:', state.code);
        const { data, error } = await DB.from('games').select('*').eq('room_code', state.code).maybeSingle();
        
        console.log('Join query result:', { data, error });
        
        if (error || !data) {
          console.error('Join error:', error);
          return alert('Room not found - check the code');
        }
        
        state.game = data.game_data;
        
        // Check if player already in game
        if (data.game_data.players.some(p => p.id === myId)) {
          console.log('Player already in game, going to lobby');
          state.view = 'lobby';
        } else {
          console.log('New player, selecting team');
          state.view = 'team';
        }
        
        render();
        setInterval(load, 2000);
      } catch (e) {
        console.error('Join exception:', e);
        alert('Error joining room: ' + e.message);
      }
    }
    
    async function selectTeam(team) {
      state.team = team;
      
      if (!state.game) {
        // Creating new room
        const game = {
          hostId: myId,
          players: [{ id: myId, name: state.name, hand: [] }],
          teams: { team1: [], team2: [] },
          phase: 'lobby',
          scores: { team1: 0, team2: 0 },
          currentTurn: '',
          log: [],
          settings: { showHistory: true, showCounts: false }
        };
        game.teams[team].push(myId);
        await save(game);
      } else {
        // Joining existing room
        const game = state.game;
        if (!game.players.find(p => p.id === myId)) {
          game.players.push({ id: myId, name: state.name, hand: [] });
          game.teams[team].push(myId);
          await save(game);
        }
      }
      
      state.view = 'lobby';
      setInterval(load, 2000);
    }
    
    async function toggleSetting(key) {
      const game = state.game;
      if (!game.settings) game.settings = {};
      game.settings[key] = !game.settings[key];
      console.log('Toggle setting:', key, 'to', game.settings[key]);
      await save(game);
    }
    
    async function leaveRoom() {
      if (!confirm('Leave this room?')) return;
      
      try {
        const { data } = await DB.from('games').select('*').eq('room_code', state.code).maybeSingle();
        if (!data) {
          state.view = 'home';
          state.code = '';
          state.game = null;
          render();
          return;
        }
        
        const game = data.game_data;
        
        // If in game phase, replace with bot
        if (game.phase === 'game') {
          const me = game.players.find(p => p.id === myId);
          if (me) {
            let n = 1;
            while (game.players.some(p => p.name === `Bot ${n}`)) n++;
            const bot = { id: `bot-${Date.now()}`, name: `${me.name} (Bot)`, hand: me.hand, isBot: true };
            
            const playerIndex = game.players.findIndex(p => p.id === myId);
            game.players[playerIndex] = bot;
            
            if (game.teams.team1.includes(myId)) {
              game.teams.team1 = game.teams.team1.map(id => id === myId ? bot.id : id);
            } else {
              game.teams.team2 = game.teams.team2.map(id => id === myId ? bot.id : id);
            }
            
            if (game.currentTurn === myId) {
              game.currentTurn = bot.id;
            }
            
            game.log.unshift(`${me.name} left and was replaced by a bot`);
            await save(game);
          }
        } else {
          // In lobby, just remove player
          game.players = game.players.filter(p => p.id !== myId);
          game.teams.team1 = game.teams.team1.filter(id => id !== myId);
          game.teams.team2 = game.teams.team2.filter(id => id !== myId);
          
          // If no players left, delete room
          if (game.players.length === 0) {
            await DB.from('games').delete().eq('room_code', state.code);
          } else {
            // Transfer host if needed
            if (game.hostId === myId) {
              game.hostId = game.players[0].id;
            }
            await save(game);
          }
        }
        
        state.view = 'home';
        state.code = '';
        state.game = null;
        render();
      } catch (e) {
        console.error('Leave error:', e);
        state.view = 'home';
        render();
      }
    }
    
    async function addBot(team) {
      const game = state.game;
      let n = 1;
      while (game.players.some(p => p.name === `Bot ${n}`)) n++;
      const bot = { id: `bot-${Date.now()}`, name: `Bot ${n}`, hand: [], isBot: true };
      game.players.push(bot);
      game.teams[team].push(bot.id);
      await save(game);
    }
    
    async function removeBot(id) {
      const game = state.game;
      game.players = game.players.filter(p => p.id !== id);
      game.teams.team1 = game.teams.team1.filter(i => i !== id);
      game.teams.team2 = game.teams.team2.filter(i => i !== id);
      await save(game);
    }
    
    async function startGame() {
      const game = state.game;
      if (game.players.length < 4) return alert('Need 4+ players');
      
      const deck = ['2‚ô†','3‚ô†','4‚ô†','5‚ô†','6‚ô†','7‚ô†','9‚ô†','10‚ô†','J‚ô†','Q‚ô†','K‚ô†','A‚ô†','2‚ô•','3‚ô•','4‚ô•','5‚ô•','6‚ô•','7‚ô•','9‚ô•','10‚ô•','J‚ô•','Q‚ô•','K‚ô•','A‚ô•','2‚ô£','3‚ô£','4‚ô£','5‚ô£','6‚ô£','7‚ô£','9‚ô£','10‚ô£','J‚ô£','Q‚ô£','K‚ô£','A‚ô£','2‚ô¶','3‚ô¶','4‚ô¶','5‚ô¶','6‚ô¶','7‚ô¶','9‚ô¶','10‚ô¶','J‚ô¶','Q‚ô¶','K‚ô¶','A‚ô¶','8‚ô•','8‚ô¶','8‚ô†','8‚ô£','RJ','BJ'];
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      
      const per = Math.floor(deck.length / game.players.length);
      game.players.forEach((p, i) => p.hand = deck.slice(i * per, (i + 1) * per));
      game.phase = 'game';
      game.currentTurn = game.players[0].id;
      await save(game);
      state.view = 'game';
    }
    
    function render() {
      const app = document.getElementById('app');
      
      if (state.view === 'home') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <h1>LITERATURE</h1>
              <input type="text" placeholder="Your Name" id="name" value="${state.name}">
              <button onclick="createRoom()">Create Room</button>
              <div style="text-align:center;margin:20px;color:#666">OR</div>
              <input type="text" placeholder="Room Code" id="code" value="${state.code}">
              <button onclick="joinRoom()">Join Room</button>
            </div>
          </div>
        `;
        document.getElementById('name').oninput = e => state.name = e.target.value;
        document.getElementById('code').oninput = e => state.code = e.target.value.toUpperCase();
        return;
      }
      
      if (state.view === 'team') {
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <h2 style="text-align:center;margin-bottom:20px">Choose Team</h2>
              <button onclick="window.selectTeam('team1')" style="background:#ef4444;color:#fff;margin-bottom:10px">Team 1 (Red)</button>
              <button onclick="window.selectTeam('team2')" style="background:#3b82f6;color:#fff">Team 2 (Blue)</button>
            </div>
          </div>
        `;
        return;
      }
      
      if (state.view === 'lobby' && state.game) {
        const isHost = state.game.hostId === myId;
        const myTeamKey = state.game.teams.team1.includes(myId) ? 'team1' : 'team2';
        const myTeamName = myTeamKey === 'team1' ? 'Team 1 (Red)' : 'Team 2 (Blue)';
        
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <h1 style="font-size:32px">${state.code}</h1>
              <p style="text-align:center;color:#888;margin-bottom:5px">Share this code</p>
              <p style="text-align:center;color:${myTeamKey === 'team1' ? '#ef4444' : '#3b82f6'};font-weight:700;margin-bottom:20px">
                You're on ${myTeamName}
              </p>
              
              ${isHost ? `
                <div style="background:#1a1f2e;padding:15px;border-radius:8px;margin-bottom:20px">
                  <h3 style="margin-bottom:10px;font-size:16px">Game Settings (Host Only)</h3>
                  <label style="display:flex;align-items:center;gap:10px;margin-bottom:8px;cursor:pointer">
                    <input type="checkbox" id="show-history" ${state.game.settings?.showHistory ? 'checked' : ''}>
                    <span>Show Ask History</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                    <input type="checkbox" id="show-counts" ${state.game.settings?.showCounts ? 'checked' : ''}>
                    <span>Show Card Counts</span>
                  </label>
                </div>
              ` : ''}
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                <div class="team">
                  <h3 class="t1">Team 1 (${state.game.teams.team1.length})</h3>
                  ${state.game.players.filter(p => state.game.teams.team1.includes(p.id)).map(p => `
                    <div class="player">
                      <span>${p.name} ${p.id === myId ? '(You)' : ''}</span>
                      ${isHost && p.isBot ? `<button class="btn-sm" onclick="window.removeBot('${p.id}')">Remove</button>` : ''}
                    </div>
                  `).join('')}
                  ${isHost ? '<button onclick="window.addBot(\'team1\')">+ Add Bot</button>' : ''}
                </div>
                
                <div class="team">
                  <h3 class="t2">Team 2 (${state.game.teams.team2.length})</h3>
                  ${state.game.players.filter(p => state.game.teams.team2.includes(p.id)).map(p => `
                    <div class="player">
                      <span>${p.name} ${p.id === myId ? '(You)' : ''}</span>
                      ${isHost && p.isBot ? `<button class="btn-sm" onclick="window.removeBot('${p.id}')">Remove</button>` : ''}
                    </div>
                  `).join('')}
                  ${isHost ? '<button onclick="window.addBot(\'team2\')">+ Add Bot</button>' : ''}
                </div>
              </div>
              
              ${isHost ? `
                <button onclick="window.startGame()" ${state.game.players.length < 4 ? 'disabled' : ''} style="margin-top:15px">
                  ${state.game.players.length < 4 ? `Need ${4 - state.game.players.length} more players` : 'Start Game'}
                </button>
              ` : '<p style="text-align:center;color:#888;margin-top:20px">Waiting for host to start...</p>'}
              
              <button onclick="window.leaveRoom()" class="btn-sm" style="margin-top:10px;background:#ef4444;width:auto;padding:8px 16px">
                Leave Room
              </button>
            </div>
          </div>
        `;
        
        if (isHost) {
          const historyCheck = document.getElementById('show-history');
          const countsCheck = document.getElementById('show-counts');
          if (historyCheck) historyCheck.onchange = () => toggleSetting('showHistory');
          if (countsCheck) countsCheck.onchange = () => toggleSetting('showCounts');
        }
        
        return;
      }
      
      if (state.view === 'game' && state.game) {
        const me = state.game.players.find(p => p.id === myId);
        const myTeam = state.game.teams.team1.includes(myId) ? 'team1' : 'team2';
        const isMyTurn = state.game.currentTurn === myId;
        const currentPlayer = state.game.players.find(p => p.id === state.game.currentTurn);
        const opponents = state.game.players.filter(p => 
          p.id !== myId && 
          state.game.teams[myTeam === 'team1' ? 'team2' : 'team1'].includes(p.id)
        );
        
        app.innerHTML = `
          <div class="container">
            <div class="card">
              <h2>Room ${state.code}</h2>
              <p>Scores - Team 1: ${state.game.scores.team1} | Team 2: ${state.game.scores.team2}</p>
              <p style="margin:10px 0;font-weight:700;color:${isMyTurn ? '#4ade80' : '#888'}">
                ${isMyTurn ? 'üü¢ YOUR TURN' : `‚è≥ ${currentPlayer?.name}'s Turn`}
              </p>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0">
                <div>
                  <h3 class="t1">Team 1</h3>
                  ${state.game.players.filter(p => state.game.teams.team1.includes(p.id)).map(p => `
                    <div class="player">
                      ${p.name} ${p.id === myId ? '(You)' : ''} - ${p.hand.length} cards
                      ${state.game.currentTurn === p.id ? ' üëâ' : ''}
                    </div>
                  `).join('')}
                </div>
                <div>
                  <h3 class="t2">Team 2</h3>
                  ${state.game.players.filter(p => state.game.teams.team2.includes(p.id)).map(p => `
                    <div class="player">
                      ${p.name} ${p.id === myId ? '(You)' : ''} - ${p.hand.length} cards
                      ${state.game.currentTurn === p.id ? ' üëâ' : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <div style="margin:20px 0">
                <h3>Your Hand (${me.hand.length} cards)</h3>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
                  ${me.hand.sort().map((c, i) => `
                    <div onclick="selectCard(${i}, '${c}')" id="card-${i}" style="background:#fff;color:${c.includes('‚ô•') || c.includes('‚ô¶') ? '#ef4444' : '#000'};padding:12px;border-radius:6px;min-width:50px;text-align:center;font-weight:700;cursor:pointer;border:3px solid transparent">
                      ${c}
                    </div>
                  `).join('')}
                </div>
              </div>
              
              ${isMyTurn ? `
                <div style="margin-top:20px">
                  <select id="opponent-select" style="margin-bottom:10px">
                    <option value="">Select Opponent</option>
                    ${opponents.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                  </select>
                  <button onclick="askCard()" id="ask-btn" disabled>Ask for Card</button>
                </div>
              ` : '<p style="text-align:center;color:#888">Waiting for turn...</p>'}
            </div>
          </div>
        `;
      }
    }
    
    let selectedCard = null;
    let selectedOpponent = null;
    
    function selectCard(idx, card) {
      selectedCard = card;
      document.querySelectorAll('[id^="card-"]').forEach(el => el.style.borderColor = 'transparent');
      document.getElementById(`card-${idx}`).style.borderColor = '#ffd700';
      updateAskBtn();
    }
    
    function updateAskBtn() {
      const btn = document.getElementById('ask-btn');
      const sel = document.getElementById('opponent-select');
      if (btn && sel) {
        selectedOpponent = sel.value;
        btn.disabled = !selectedCard || !selectedOpponent;
      }
    }
    
    async function askCard() {
      if (!selectedCard || !selectedOpponent) return;
      
      const game = state.game;
      const opponent = game.players.find(p => p.id === selectedOpponent);
      const me = game.players.find(p => p.id === myId);
      
      const hasCard = opponent.hand.includes(selectedCard);
      
      if (hasCard) {
        opponent.hand = opponent.hand.filter(c => c !== selectedCard);
        me.hand.push(selectedCard);
        game.log = game.log || [];
        game.log.unshift(`${me.name} asked ${opponent.name} for ${selectedCard} - SUCCESS!`);
      } else {
        game.currentTurn = opponent.id;
        game.log = game.log || [];
        game.log.unshift(`${me.name} asked ${opponent.name} for ${selectedCard} - FAILED`);
      }
      
      selectedCard = null;
      selectedOpponent = null;
      await save(game);
    }
    
    window.selectCard = selectCard;
    window.askCard = askCard;
    window.addEventListener('change', (e) => {
      if (e.target.id === 'opponent-select') updateAskBtn();
    });
    
    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.selectTeam = selectTeam;
    window.addBot = addBot;
    window.removeBot = removeBot;
    window.startGame = startGame;
    
    render();
  </script>
</body>
</html>
