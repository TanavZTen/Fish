<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Literature - Poker Table</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0d1b2a;
      color: #fff;
    }
    .home-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .home-card {
      background: linear-gradient(135deg, #1b263b 0%, #0d1b2a 100%);
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .home-title {
      font-size: 42px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .home-subtitle {
      text-align: center;
      color: #8892b0;
      margin-bottom: 30px;
    }
    input, select {
      width: 100%;
      padding: 12px 16px;
      background: #0d1b2a;
      border: 2px solid #415a77;
      border-radius: 10px;
      color: #fff;
      font-size: 16px;
      margin-bottom: 15px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #ffd700;
    }
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      color: #0d1b2a;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #415a77;
      color: #fff;
    }
    .divider {
      text-align: center;
      margin: 20px 0;
      color: #8892b0;
    }
    
    /* Poker Table */
    .table-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }
    .poker-table {
      width: 95vw;
      max-width: 1200px;
      height: 80vh;
      min-height: 600px;
      background: radial-gradient(ellipse at center, #1a5f3a 0%, #0d3b24 100%);
      border-radius: 50%;
      position: relative;
      box-shadow: 
        0 0 0 15px #8b4513,
        0 0 0 20px #654321,
        0 30px 80px rgba(0,0,0,0.8);
      border: 3px solid #2d1810;
    }
    .table-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }
    .room-code-display {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 5px;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255,215,0,0.5);
      margin-bottom: 10px;
    }
    .turn-indicator {
      font-size: 18px;
      color: #fff;
      background: rgba(0,0,0,0.5);
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
    }
    
    /* Player Seats */
    .seat {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .seat.pos-bottom {
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
    }
    .seat.pos-top {
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
    }
    .seat.pos-left {
      left: 10%;
      top: 50%;
      transform: translateY(-50%);
    }
    .seat.pos-right {
      right: 10%;
      top: 50%;
      transform: translateY(-50%);
    }
    .seat.pos-top-left {
      left: 20%;
      top: 15%;
    }
    .seat.pos-top-right {
      right: 20%;
      top: 15%;
    }
    .seat.pos-bottom-left {
      left: 20%;
      bottom: 15%;
    }
    .seat.pos-bottom-right {
      right: 20%;
      bottom: 15%;
    }
    
    .player-info {
      background: linear-gradient(135deg, #1b263b, #0d1b2a);
      padding: 12px 20px;
      border-radius: 20px;
      border: 2px solid #415a77;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      min-width: 140px;
      text-align: center;
    }
    .player-info.active {
      border-color: #ffd700;
      box-shadow: 0 0 30px rgba(255,215,0,0.6);
    }
    .player-info.self {
      border-color: #4ade80;
    }
    .player-name {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .player-team {
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 10px;
      display: inline-block;
    }
    .team1 {
      background: #ef4444;
      color: #fff;
    }
    .team2 {
      background: #3b82f6;
      color: #fff;
    }
    .player-cards {
      display: flex;
      gap: 5px;
      justify-content: center;
      margin-top: 8px;
    }
    .card-back {
      width: 35px;
      height: 50px;
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      border-radius: 5px;
      border: 2px solid #1e293b;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    
    /* Your Hand */
    .hand-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #1b263b, #0d1b2a);
      padding: 20px;
      border-radius: 20px;
      border: 2px solid #415a77;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      max-width: 90vw;
      z-index: 100;
    }
    .hand-title {
      font-size: 14px;
      color: #8892b0;
      margin-bottom: 10px;
      text-align: center;
    }
    .hand-cards {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 15px;
    }
    .card {
      width: 70px;
      height: 100px;
      background: #fff;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
    }
    .card:hover {
      transform: translateY(-10px);
    }
    .card.selected {
      transform: translateY(-15px);
      box-shadow: 0 8px 25px rgba(255,215,0,0.8);
      border: 3px solid #ffd700;
    }
    .card.red {
      color: #dc2626;
    }
    .card.black {
      color: #000;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .actions select {
      width: auto;
      min-width: 150px;
      margin-bottom: 0;
    }
    .actions button {
      width: auto;
      padding: 10px 20px;
      margin-bottom: 0;
    }
    
    /* Lobby specific */
    .lobby-settings {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .setting-row label {
      color: #8892b0;
      font-size: 14px;
    }
    .setting-row input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .teams-list {
      display: flex;
      gap: 30px;
      margin: 20px 0;
    }
    .team-column {
      flex: 1;
    }
    .team-column h3 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    .team-column.t1 h3 {
      color: #ef4444;
    }
    .team-column.t2 h3 {
      color: #3b82f6;
    }
    .team-player {
      background: rgba(255,255,255,0.05);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .team-player.you {
      border: 2px solid #4ade80;
    }
    .remove-btn {
      width: auto;
      padding: 5px 10px;
      font-size: 12px;
      background: #ef4444;
      margin: 0;
    }
    .add-bot-btn {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const SUPABASE_URL = 'https://vngdiukjrfmzwlbefmjf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuZ2RpdWtqcmZtendsYmVmbWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0Njk5MDUsImV4cCI6MjA4MzA0NTkwNX0.XBr7aEzSPj-Iw0HYf27T8yXo1nbZ01MhBVa-VIdNZG4';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const SETS = [
      { name: 'Spades 2-7', cards: ['2♠', '3♠', '4♠', '5♠', '6♠', '7♠'] },
      { name: 'Spades 9-A', cards: ['9♠', '10♠', 'J♠', 'Q♠', 'K♠', 'A♠'] },
      { name: 'Hearts 2-7', cards: ['2♥', '3♥', '4♥', '5♥', '6♥', '7♥'] },
      { name: 'Hearts 9-A', cards: ['9♥', '10♥', 'J♥', 'Q♥', 'K♥', 'A♥'] },
      { name: 'Clubs 2-7', cards: ['2♣', '3♣', '4♣', '5♣', '6♣', '7♣'] },
      { name: 'Clubs 9-A', cards: ['9♣', '10♣', 'J♣', 'Q♣', 'K♣', 'A♣'] },
      { name: 'Diamonds 2-7', cards: ['2♦', '3♦', '4♦', '5♦', '6♦', '7♦'] },
      { name: 'Diamonds 9-A', cards: ['9♦', '10♦', 'J♦', 'Q♦', 'K♦', 'A♦'] },
      { name: '8s + Jokers', cards: ['8♥', '8♦', '8♠', '8♣', 'RJ', 'BJ'] }
    ];

    const CLIENT_ID_KEY = 'literature-client-id';
    function getClientId() {
      let id = localStorage.getItem(CLIENT_ID_KEY);
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem(CLIENT_ID_KEY, id);
      }
      return id;
    }

    const shuffle = deck => {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
    };

    function createBot(players) {
      let n = 1;
      while (players.some(p => p.name === `Bot ${n}`)) n++;
      return {
        id: `bot-${crypto.randomUUID()}`,
        name: `Bot ${n}`,
        hand: [],
        isBot: true
      };
    }

    const App = () => {
      const myId = useMemo(() => getClientId(), []);
      
      const [view, setView] = useState('home');
      const [roomCode, setRoomCode] = useState('');
      const [playerName, setPlayerName] = useState('');
      const [selectedTeam, setSelectedTeam] = useState('team1');
      const [gameData, setGameData] = useState(null);
      
      const [selectedCard, setSelectedCard] = useState('');
      const [selectedOpponent, setSelectedOpponent] = useState('');

      const saveGame = async (data) => {
        try {
          if (!roomCode) return;
          const { error } = await supabase
            .from('games')
            .upsert({ 
              room_code: roomCode, 
              game_data: data,
              updated_at: new Date().toISOString()
            });
          
          if (error) console.error('Save error:', error);
          
          // Immediately update local state
          setGameData({...data});
        } catch (e) {
          console.error('saveGame error', e);
        }
      };

      const loadGame = async () => {
        if (!roomCode) return;
        try {
          const { data, error } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();
          
          if (!error && data) {
            setGameData(data.game_data);
          }
        } catch (e) {
          console.error('Load error:', e);
        }
      };

      useEffect(() => {
        if (!roomCode) return;
        loadGame();
        const interval = setInterval(loadGame, 2000);
        return () => clearInterval(interval);
      }, [roomCode]);

      const createRoom = () => {
        if (!playerName.trim()) {
          alert('Please enter your name');
          return;
        }
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        setRoomCode(code);
        
        const initialData = {
          hostId: myId,
          phase: 'lobby',
          players: [{ id: myId, name: playerName, hand: [], isBot: false }],
          teams: {
            team1: selectedTeam === 'team1' ? [myId] : [],
            team2: selectedTeam === 'team2' ? [myId] : []
          },
          currentTurn: '',
          scores: { team1: 0, team2: 0 },
          claimedSets: [],
          gameLog: [],
          settings: {
            showCardCounts: false,
            turnTimeLimit: 0
          }
        };

        saveGame(initialData);
        setView('lobby');
      };

      const joinRoom = async () => {
        if (!playerName.trim() || !roomCode.trim()) {
          alert('Please enter your name and room code');
          return;
        }

        try {
          const { data, error } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode.toUpperCase())
            .single();

          if (error || !data) {
            alert('Room not found!');
            return;
          }

          const gameData = data.game_data;
          
          if (gameData.players.some(p => p.id === myId)) {
            setView('lobby');
            return;
          }

          gameData.players.push({ id: myId, name: playerName, hand: [], isBot: false });
          gameData.teams[selectedTeam].push(myId);
          await saveGame(gameData);
          setView('lobby');
        } catch (e) {
          alert('Error joining room');
        }
      };

      const addBot = async (team) => {
        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          if (!data) return;

          const gameData = data.game_data;
          const bot = createBot(gameData.players);
          gameData.players.push(bot);
          gameData.teams[team].push(bot.id);
          
          await saveGame(gameData);
        } catch (e) {
          console.error('Error adding bot:', e);
        }
      };

      const removePlayer = async (playerId) => {
        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          if (!data) return;

          const gameData = data.game_data;
          gameData.players = gameData.players.filter(p => p.id !== playerId);
          gameData.teams.team1 = gameData.teams.team1.filter(id => id !== playerId);
          gameData.teams.team2 = gameData.teams.team2.filter(id => id !== playerId);
          
          await saveGame(gameData);
        } catch (e) {
          console.error('Error removing player:', e);
        }
      };

      const startGame = async () => {
        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          const gameData = data.game_data;
          
          if (gameData.players.length < 4) {
            alert('Need at least 4 players to start!');
            return;
          }

          let deck = [];
          SETS.forEach(set => deck.push(...set.cards));
          shuffle(deck);

          const cardsPerPlayer = Math.floor(deck.length / gameData.players.length);
          gameData.players.forEach((p, idx) => {
            p.hand = deck.slice(idx * cardsPerPlayer, (idx + 1) * cardsPerPlayer);
          });

          gameData.phase = 'game';
          gameData.currentTurn = gameData.players[0].id;
          gameData.gameLog.unshift('Game started!');

          await saveGame(gameData);
          setView('game');
        } catch (e) {
          alert('Error starting game');
        }
      };

      const askForCard = async () => {
        if (!selectedOpponent || !selectedCard) {
          alert('Select opponent and card!');
          return;
        }

        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          const gameData = data.game_data;
          const opponent = gameData.players.find(p => p.id === selectedOpponent);
          const me = gameData.players.find(p => p.id === myId);

          const hasCard = opponent.hand.includes(selectedCard);

          if (hasCard) {
            opponent.hand = opponent.hand.filter(c => c !== selectedCard);
            me.hand.push(selectedCard);
            gameData.gameLog.unshift(`${me.name} asked ${opponent.name} for ${selectedCard} - SUCCESS!`);
          } else {
            gameData.currentTurn = opponent.id;
            gameData.gameLog.unshift(`${me.name} asked ${opponent.name} for ${selectedCard} - FAILED`);
          }

          await saveGame(gameData);
          setSelectedCard('');
          setSelectedOpponent('');
        } catch (e) {
          alert('Error making move');
        }
      };

      const getPlayerPosition = (index, total) => {
        const positions = ['bottom', 'left', 'top-left', 'top', 'top-right', 'right', 'bottom-right', 'bottom-left'];
        if (total <= 4) {
          return ['bottom', 'left', 'top', 'right'][index] || 'bottom';
        }
        return positions[index] || 'bottom';
      };

      if (view === 'home') {
        return (
          <div className="home-screen">
            <div className="home-card">
              <h1 className="home-title">LITERATURE</h1>
              <p className="home-subtitle">The Classic Card Game</p>
              
              <input
                type="text"
                placeholder="Your Name"
                value={playerName}
                onChange={(e) => setPlayerName(e.target.value)}
              />
              
              <select value={selectedTeam} onChange={(e) => setSelectedTeam(e.target.value)}>
                <option value="team1">Team 1 (Red)</option>
                <option value="team2">Team 2 (Blue)</option>
              </select>

              <button onClick={createRoom}>Create Room</button>
              
              <div className="divider">- OR -</div>
              
              <input
                type="text"
                placeholder="Room Code"
                value={roomCode}
                onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
              />
              
              <button onClick={joinRoom} className="btn-secondary">Join Room</button>
            </div>
          </div>
        );
      }

      if (view === 'lobby' && gameData) {
        const isHost = gameData.hostId === myId;
        
        return (
          <div className="home-screen">
            <div className="home-card" style={{maxWidth: '700px'}}>
              <div className="room-code-display">{roomCode}</div>
              <p className="home-subtitle">Share this code with your friends</p>

              <div className="teams-list">
                <div className="team-column t1">
                  <h3>Team 1 (Red)</h3>
                  {gameData.players
                    .filter(p => gameData.teams.team1.includes(p.id))
                    .map(p => (
                      <div key={p.id} className={`team-player ${p.id === myId ? 'you' : ''}`}>
                        <span>{p.name} {p.id === myId && '(You)'}</span>
                        {isHost && p.isBot && (
                          <button onClick={() => removePlayer(p.id)} className="remove-btn">Remove</button>
                        )}
                      </div>
                    ))}
                  {isHost && (
                    <button onClick={() => addBot('team1')} className="add-bot-btn">+ Add Bot</button>
                  )}
                </div>

                <div className="team-column t2">
                  <h3>Team 2 (Blue)</h3>
                  {gameData.players
                    .filter(p => gameData.teams.team2.includes(p.id))
                    .map(p => (
                      <div key={p.id} className={`team-player ${p.id === myId ? 'you' : ''}`}>
                        <span>{p.name} {p.id === myId && '(You)'}</span>
                        {isHost && p.isBot && (
                          <button onClick={() => removePlayer(p.id)} className="remove-btn">Remove</button>
                        )}
                      </div>
                    ))}
                  {isHost && (
                    <button onClick={() => addBot('team2')} className="add-bot-btn">+ Add Bot</button>
                  )}
                </div>
              </div>

              {isHost && (
                <button onClick={startGame} disabled={gameData.players.length < 4}>
                  {gameData.players.length < 4 
                    ? `Need ${4 - gameData.players.length} more players` 
                    : 'Start Game'}
                </button>
              )}
            </div>
          </div>
        );
      }

      if (view === 'game' && gameData) {
        const me = gameData.players.find(p => p.id === myId);
        const myTeam = gameData.teams.team1.includes(myId) ? 'team1' : 'team2';
        const isMyTurn = gameData.currentTurn === myId;
        const currentPlayer = gameData.players.find(p => p.id === gameData.currentTurn);

        const otherPlayers = gameData.players.filter(p => p.id !== myId);
        const opponents = gameData.players.filter(p => 
          p.id !== myId && 
          gameData.teams[myTeam === 'team1' ? 'team2' : 'team1'].includes(p.id)
        );

        return (
          <div className="table-container">
            <div className="poker-table">
              <div className="table-center">
                <div className="room-code-display">{roomCode}</div>
                <div className="turn-indicator">
                  {isMyTurn ? "YOUR TURN" : `${currentPlayer?.name}'s Turn`}
                </div>
              </div>

              {otherPlayers.map((player, idx) => {
                const position = getPlayerPosition(idx + 1, gameData.players.length);
                const playerTeam = gameData.teams.team1.includes(player.id) ? 'team1' : 'team2';
                const isActive = gameData.currentTurn === player.id;

                return (
                  <div key={player.id} className={`seat pos-${position}`}>
                    <div className={`player-info ${isActive ? 'active' : ''}`}>
                      <div className="player-name">{player.name}</div>
                      <div className={`player-team ${playerTeam}`}>
                        {playerTeam === 'team1' ? 'Team 1' : 'Team 2'}
                      </div>
                      {gameData.settings.showCardCounts && (
                        <div style={{fontSize: '12px', marginTop: '5px', color: '#8892b0'}}>
                          {player.hand?.length || 0} cards
                        </div>
                      )}
                    </div>
                    <div className="player-cards">
                      {Array(Math.min(player.hand?.length || 3, 6)).fill(0).map((_, i) => (
                        <div key={i} className="card-back" />
                      ))}
                    </div>
                  </div>
                );
              })}

              <div className="hand-panel">
                <div className="hand-title">YOUR HAND ({me?.hand?.length || 0} cards)</div>
                <div className="hand-cards">
                  {me?.hand?.sort().map((card, i) => {
                    const isRed = card.includes('♥') || card.includes('♦');
                    return (
                      <div
                        key={i}
                        className={`card ${isRed ? 'red' : 'black'} ${selectedCard === card ? 'selected' : ''}`}
                        onClick={() => {
                          if (!isMyTurn) {
                            alert('Not your turn!');
                            return;
                          }
                          setSelectedCard(selectedCard === card ? '' : card);
                        }}
                      >
                        {card}
                      </div>
                    );
                  })}
                </div>
                
                {isMyTurn && (
                  <div className="actions">
                    <select
                      value={selectedOpponent}
                      onChange={(e) => setSelectedOpponent(e.target.value)}
                    >
                      <option value="">Select Opponent</option>
                      {opponents.map(p => (
                        <option key={p.id} value={p.id}>{p.name}</option>
                      ))}
                    </select>
                    
                    <button onClick={askForCard} disabled={!selectedCard || !selectedOpponent}>
                      Ask for Card
                    </button>
                    
                    <button className="btn-secondary">
                      Call Set
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      return null;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
