<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Literature — 9 Set Variant</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-green-900 text-white">
<div id="root"></div>

<script type="text/babel">
/* ============================================================
   PERSISTENT CLIENT ID (CRITICAL FIX)
   ============================================================ */
const CLIENT_ID_KEY = 'literature-client-id';

function getClientId() {
  let id = localStorage.getItem(CLIENT_ID_KEY);
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem(CLIENT_ID_KEY, id);
  }
  return id;
}

/* ============================================================
   GAME CONSTANTS
   ============================================================ */
const SETS = [
  { name: 'Spades 2–7', cards: ['2♠','3♠','4♠','5♠','6♠','7♠'] },
  { name: 'Spades 9–A', cards: ['9♠','10♠','J♠','Q♠','K♠','A♠'] },
  { name: 'Hearts 2–7', cards: ['2♥','3♥','4♥','5♥','6♥','7♥'] },
  { name: 'Hearts 9–A', cards: ['9♥','10♥','J♥','Q♥','K♥','A♥'] },
  { name: 'Clubs 2–7', cards: ['2♣','3♣','4♣','5♣','6♣','7♣'] },
  { name: 'Clubs 9–A', cards: ['9♣','10♣','J♣','Q♣','K♣','A♣'] },
  { name: 'Diamonds 2–7', cards: ['2♦','3♦','4♦','5♦','6♦','7♦'] },
  { name: 'Diamonds 9–A', cards: ['9♦','10♦','J♦','Q♦','K♦','A♦'] },
  { name: '8s + Jokers', cards: ['8♥','8♦','8♠','8♣','RJ','BJ'] }
];

/* ============================================================
   UTILITIES
   ============================================================ */
function shuffle(deck) {
  for (let i = deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
}

function findSet(card) {
  return SETS.find(s => s.cards.includes(card));
}

function nameExists(players, name) {
  return players.some(p => p.name.toLowerCase() === name.toLowerCase());
}

function createBot(players) {
  let n = 1;
  while (players.some(p => p.name === `Bot ${n}`)) n++;
  return {
    id: `bot-${crypto.randomUUID()}`,
    name: `Bot ${n}`,
    hand: [],
    isBot: true
  };
}

/* ============================================================
   APP
   ============================================================ */
const App = () => {
  const [view, setView] = React.useState('home');
  const [roomCode, setRoomCode] = React.useState('');
  const [playerName, setPlayerName] = React.useState('');
  const [teamChoice, setTeamChoice] = React.useState('');
  const [game, setGame] = React.useState(null);

  // PERSISTENT ID — NEVER CHANGES
  const myId = React.useMemo(() => getClientId(), []);

  /* ============================================================
     LOAD & SYNC GAME
     ============================================================ */
  const loadGame = () => {
    if (!roomCode) return;
    const raw = localStorage.getItem(`game:${roomCode}`);
    if (!raw) return;

    const data = JSON.parse(raw);
    setGame(data);

    if (data.started) {
      const current = data.players.find(p => p.id === data.currentTurn);
      if (current?.isBot) {
        setTimeout(() => runBotTurn(current, data), 800);
      }
    }
  };

  React.useEffect(() => {
    if (!roomCode) return;
    const i = setInterval(loadGame, 1500);
    return () => clearInterval(i);
  }, [roomCode]);

  /* ============================================================
     CREATE ROOM
     ============================================================ */
  const createRoom = () => {
    const code = Math.random().toString(36).substring(2,8).toUpperCase();
    setRoomCode(code);
    setView('team');
  };

  const confirmCreate = () => {
    const gameState = {
      players: [{
        id: myId,
        name: playerName,
        hand: [],
        isBot: false
      }],
      teams: {
        team1: teamChoice === 'team1' ? [myId] : [],
        team2: teamChoice === 'team2' ? [myId] : []
      },
      scores: { team1: 0, team2: 0 },
      currentTurn: '',
      started: false,
      log: []
    };

    localStorage.setItem(`game:${roomCode}`, JSON.stringify(gameState));
    loadGame();
    setView('waiting');
  };

  /* ============================================================
     JOIN ROOM
     ============================================================ */
  const joinRoom = () => {
    const raw = localStorage.getItem(`game:${roomCode}`);
    if (!raw) return alert('Room not found');

    const data = JSON.parse(raw);

    // already joined on this browser
    if (data.players.some(p => p.id === myId)) {
      setView('waiting');
      return;
    }

    // name collision
    if (nameExists(data.players, playerName)) {
      alert('Name already taken');
      return;
    }

    setView('team');
  };

  const confirmJoin = () => {
    const data = JSON.parse(localStorage.getItem(`game:${roomCode}`));

    if (!data.players.some(p => p.id === myId)) {
      data.players.push({
        id: myId,
        name: playerName,
        hand: [],
        isBot: false
      });
    }

    if (!data.teams[teamChoice].includes(myId)) {
      data.teams[teamChoice].push(myId);
    }

    localStorage.setItem(`game:${roomCode}`, JSON.stringify(data));
    loadGame();
    setView('waiting');
  };

  /* ============================================================
     BOT MANAGEMENT
     ============================================================ */
  const addBot = (team) => {
    const data = JSON.parse(localStorage.getItem(`game:${roomCode}`));
    const bot = createBot(data.players);
    data.players.push(bot);
    data.teams[team].push(bot.id);
    localStorage.setItem(`game:${roomCode}`, JSON.stringify(data));
    loadGame();
  };

  /* ============================================================
     START GAME
     ============================================================ */
  const startGame = () => {
    const data = JSON.parse(localStorage.getItem(`game:${roomCode}`));

    let deck = [];
    SETS.forEach(s => deck.push(...s.cards));
    shuffle(deck);

    data.players.forEach((p, i) => {
      p.hand = deck.filter((_, idx) => idx % data.players.length === i);
    });

    data.started = true;
    data.currentTurn = data.players[0].id;
    data.log.unshift('Game started');

    localStorage.setItem(`game:${roomCode}`, JSON.stringify(data));
    loadGame();
  };

  /* ============================================================
     BOT TURN LOGIC
     ============================================================ */
  const runBotTurn = (bot, data) => {
    const myTeam = data.teams.team1.includes(bot.id) ? 'team1' : 'team2';
    const oppTeam = myTeam === 'team1' ? 'team2' : 'team1';
    const opponents = data.players.filter(p => data.teams[oppTeam].includes(p.id));

    const askable = new Set();
    bot.hand.forEach(card => {
      const set = findSet(card);
      set.cards.forEach(c => {
        if (!bot.hand.includes(c)) askable.add(c);
      });
    });

    if (askable.size === 0) {
      data.currentTurn = opponents[0].id;
    } else {
      const card = Array.from(askable)[Math.floor(Math.random() * askable.size)];
      const opp = opponents[Math.floor(Math.random() * opponents.length)];

      if (opp.hand.includes(card)) {
        opp.hand = opp.hand.filter(c => c !== card);
        bot.hand.push(card);
        data.log.unshift(`${bot.name} took ${card} from ${opp.name}`);
      } else {
        data.currentTurn = opp.id;
        data.log.unshift(`${bot.name} failed asking ${opp.name}`);
      }
    }

    localStorage.setItem(`game:${roomCode}`, JSON.stringify(data));
    loadGame();
  };

  /* ============================================================
     UI
     ============================================================ */
  if (view === 'home') {
    return (
      <div className="p-8 text-center">
        <h1 className="text-4xl font-bold mb-4">Literature</h1>
        <input
          className="text-black p-2 mb-4"
          placeholder="Your Name"
          onChange={e => setPlayerName(e.target.value)}
        />
        <div>
          <button onClick={createRoom} className="bg-green-600 px-4 py-2 m-2">Create</button>
          <input
            className="text-black p-2 mx-2"
            placeholder="Room Code"
            onChange={e => setRoomCode(e.target.value.toUpperCase())}
          />
          <button onClick={joinRoom} className="bg-blue-600 px-4 py-2 m-2">Join</button>
        </div>
      </div>
    );
  }

  if (view === 'team') {
    return (
      <div className="p-8 text-center">
        <h2 className="text-2xl mb-4">Choose Team</h2>
        <button onClick={() => setTeamChoice('team1')} className="bg-blue-600 px-4 py-2 m-2">Team 1</button>
        <button onClick={() => setTeamChoice('team2')} className="bg-red-600 px-4 py-2 m-2">Team 2</button>
        <div>
          <button
            onClick={game ? confirmJoin : confirmCreate}
            className="bg-green-700 px-6 py-2 mt-4"
          >
            Confirm
          </button>
        </div>
      </div>
    );
  }

  if (view === 'waiting' && game) {
    return (
      <div className="p-8">
        <h2 className="text-2xl mb-2">Room {roomCode}</h2>
        <div className="grid grid-cols-2 gap-6">
          <div>
            <h3 className="font-bold">Team 1</h3>
            <button onClick={() => addBot('team1')} className="text-sm underline">+ Bot</button>
            {game.teams.team1.map(id => (
              <div key={id}>{game.players.find(p => p.id === id)?.name}</div>
            ))}
          </div>
          <div>
            <h3 className="font-bold">Team 2</h3>
            <button onClick={() => addBot('team2')} className="text-sm underline">+ Bot</button>
            {game.teams.team2.map(id => (
              <div key={id}>{game.players.find(p => p.id === id)?.name}</div>
            ))}
          </div>
        </div>
        <button onClick={startGame} className="bg-green-600 px-4 py-2 mt-6">Start Game</button>
      </div>
    );
  }

  return <div className="p-8">Game in progress…</div>;
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
