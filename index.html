<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Literature</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-green-900 text-white">
<div id="root"></div>

<script type="text/babel">
/* ============================================================
   IDENTITY (persistent per browser)
   ============================================================ */
const CLIENT_ID_KEY = 'literature-client-id';
function getClientId() {
  let id = localStorage.getItem(CLIENT_ID_KEY);
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem(CLIENT_ID_KEY, id);
  }
  return id;
}

/* ============================================================
   SET DEFINITIONS
   ============================================================ */
const SETS = [
  { name:'Spades 2–7', cards:['2♠','3♠','4♠','5♠','6♠','7♠'] },
  { name:'Spades 9–A', cards:['9♠','10♠','J♠','Q♠','K♠','A♠'] },
  { name:'Hearts 2–7', cards:['2♥','3♥','4♥','5♥','6♥','7♥'] },
  { name:'Hearts 9–A', cards:['9♥','10♥','J♥','Q♥','K♥','A♥'] },
  { name:'Clubs 2–7', cards:['2♣','3♣','4♣','5♣','6♣','7♣'] },
  { name:'Clubs 9–A', cards:['9♣','10♣','J♣','Q♣','K♣','A♣'] },
  { name:'Diamonds 2–7', cards:['2♦','3♦','4♦','5♦','6♦','7♦'] },
  { name:'Diamonds 9–A', cards:['9♦','10♦','J♦','Q♦','K♦','A♦'] },
  { name:'8s + Jokers', cards:['8♥','8♦','8♠','8♣','RJ','BJ'] }
];

const findSet = card => SETS.find(s => s.cards.includes(card));

const shuffle = deck => {
  for (let i=deck.length-1;i>0;i--) {
    const j=Math.floor(Math.random()*(i+1));
    [deck[i],deck[j]]=[deck[j],deck[i]];
  }
};

/* ============================================================
   BOT MEMORY
   ============================================================ */
function createBot(players) {
  let n=1;
  while(players.some(p=>p.name===`Bot ${n}`)) n++;
  return {
    id:`bot-${crypto.randomUUID()}`,
    name:`Bot ${n}`,
    hand:[],
    isBot:true,
    memory:{}
  };
}

/* ============================================================
   APP
   ============================================================ */
const App = () => {
  const myId = React.useMemo(()=>getClientId(),[]);
  const [view,setView]=React.useState('home');
  const [room,setRoom]=React.useState('');
  const [name,setName]=React.useState('');
  const [team,setTeam]=React.useState('');
  const [game,setGame]=React.useState(null);

  /* ========================= LOAD ========================= */
  const loadGame=()=>{
    if(!room) return;
    const raw=localStorage.getItem(`game:${room}`);
    if(!raw) return;
    const data=JSON.parse(raw);
    setGame(data);

    if(data.phase==='game'){
      const current=data.players.find(p=>p.id===data.currentTurn);
      if(current?.isBot && data.dev.autoplay){
        setTimeout(()=>botTurn(current,data),700);
      }
    }
  };

  React.useEffect(()=>{
    if(!room) return;
    const i=setInterval(loadGame,1200);
    return()=>clearInterval(i);
  },[room]);

  /* ========================= CREATE ========================= */
  const createRoom=()=>{
    const code=Math.random().toString(36).substring(2,8).toUpperCase();
    setRoom(code);
    setView('team');
  };

  const confirmCreate=()=>{
    const state={
      hostId:myId,
      phase:'lobby',
      players:[{id:myId,name,hand:[],isBot:false}],
      teams:{team1:team==='team1'?[myId]:[],team2:team==='team2'?[myId]:[]},
      currentTurn:'',
      claimed:[],
      askHistory:[],
      settings:{showAskHistory:true},
      dev:{autoplay:false},
      log:[]
    };
    localStorage.setItem(`game:${room}`,JSON.stringify(state));
    setView('lobby');
    loadGame();
  };

  /* ========================= JOIN ========================= */
  const joinRoom=()=>{
    const raw=localStorage.getItem(`game:${room}`);
    if(!raw) return alert('Room not found');
    const data=JSON.parse(raw);
    if(data.players.some(p=>p.name.toLowerCase()===name.toLowerCase())){
      alert('Name already taken');
      return;
    }
    if(data.players.some(p=>p.id===myId)){
      setView('lobby'); return;
    }
    setView('team');
  };

  const confirmJoin=()=>{
    const data=JSON.parse(localStorage.getItem(`game:${room}`));
    data.players.push({id:myId,name,hand:[],isBot:false});
    data.teams[team].push(myId);
    localStorage.setItem(`game:${room}`,JSON.stringify(data));
    setView('lobby');
    loadGame();
  };

  /* ========================= START ========================= */
  const startGame=()=>{
    const data=JSON.parse(localStorage.getItem(`game:${room}`));
    let deck=[];
    SETS.forEach(s=>deck.push(...s.cards));
    shuffle(deck);
    data.players.forEach((p,i)=>{
      p.hand=deck.filter((_,idx)=>idx%data.players.length===i);
    });
    data.phase='game';
    data.currentTurn=data.players[0].id;
    localStorage.setItem(`game:${room}`,JSON.stringify(data));
    setView('game');
    loadGame();
  };

  /* ========================= ASK LOGIC ========================= */
  const recordAsk=(from,to,card,success)=>{
    const data=JSON.parse(localStorage.getItem(`game:${room}`));
    data.askHistory.unshift({from,to,card,success});
    data.askHistory=data.askHistory.slice(0,2);
    localStorage.setItem(`game:${room}`,JSON.stringify(data));
  };

  /* ========================= BOT TURN ========================= */
  const botTurn=(bot,data)=>{
    const myTeam=data.teams.team1.includes(bot.id)?'team1':'team2';
    const oppTeam=myTeam==='team1'?'team2':'team1';
    const opponents=data.players.filter(p=>data.teams[oppTeam].includes(p.id));

    let possible=[];
    bot.hand.forEach(c=>{
      const set=findSet(c);
      set.cards.forEach(x=>{
        if(!bot.hand.includes(x)) possible.push(x);
      });
    });

    if(!possible.length){
      data.currentTurn=opponents[0].id;
      localStorage.setItem(`game:${room}`,JSON.stringify(data));
      return;
    }

    const card=possible[Math.floor(Math.random()*possible.length)];
    const target=opponents[Math.floor(Math.random()*opponents.length)];

    if(target.hand.includes(card)){
      target.hand=target.hand.filter(c=>c!==card);
      bot.hand.push(card);
      recordAsk(bot.name,target.name,card,true);
    } else {
      recordAsk(bot.name,target.name,card,false);
      data.currentTurn=target.id;
    }

    localStorage.setItem(`game:${room}`,JSON.stringify(data));
    loadGame();
  };

  /* ========================= DEV MODE ========================= */
  const devFill=()=>{
    const data=JSON.parse(localStorage.getItem(`game:${room}`));
    while(data.players.length<6){
      const bot=createBot(data.players);
      data.players.push(bot);
      (data.players.length%2?data.teams.team1:data.teams.team2).push(bot.id);
    }
    localStorage.setItem(`game:${room}`,JSON.stringify(data));
    loadGame();
  };

  /* ========================= UI ========================= */
  if(view==='home'){
    return (
      <div className="p-8 text-center">
        <h1 className="text-4xl mb-4 font-bold">Literature</h1>
        <input className="text-black p-2 mb-2" placeholder="Name" onChange={e=>setName(e.target.value)} />
        <div>
          <button className="bg-green-600 px-4 py-2 m-2" onClick={createRoom}>Create</button>
          <input className="text-black p-2 m-2" placeholder="Room" onChange={e=>setRoom(e.target.value.toUpperCase())}/>
          <button className="bg-blue-600 px-4 py-2 m-2" onClick={joinRoom}>Join</button>
        </div>
      </div>
    );
  }

  if(view==='team'){
    return (
      <div className="p-8 text-center">
        <button onClick={()=>setTeam('team1')} className="bg-blue-600 px-4 py-2 m-2">Team 1</button>
        <button onClick={()=>setTeam('team2')} className="bg-red-600 px-4 py-2 m-2">Team 2</button>
        <div>
          <button className="bg-green-700 px-6 py-2 mt-4" onClick={game?confirmJoin:confirmCreate}>Confirm</button>
        </div>
      </div>
    );
  }

  if(view==='lobby' && game){
    return (
      <div className="p-8">
        <h2 className="text-2xl">Room {room}</h2>
        <button onClick={devFill} className="underline text-sm">Developer Test Mode</button>
        <button onClick={startGame} className="bg-green-600 px-4 py-2 mt-4">Start</button>
      </div>
    );
  }

  if(view==='game' && game){
    const me=game.players.find(p=>p.id===myId);
    return (
      <div className="p-6">
        <h2 className="text-xl">Turn: {game.players.find(p=>p.id===game.currentTurn)?.name}</h2>

        {game.settings.showAskHistory && (
          <div className="bg-black/40 p-2 mt-2">
            <h4 className="font-bold">Ask History</h4>
            {game.askHistory.map((a,i)=>(
              <div key={i}>
                {a.from} asked {a.to} for {a.card} → {a.success?'✓':'✗'}
              </div>
            ))}
          </div>
        )}

        <h3 className="mt-4 font-bold">Your Hand</h3>
        <div className="flex flex-wrap gap-2">
          {me?.hand.map(c=>(
            <div key={c} className="bg-white text-black px-2 py-1 rounded">{c}</div>
          ))}
        </div>
      </div>
    );
  }

  return null;
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
