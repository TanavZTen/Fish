<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Literature Card Game</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .poker-table {
      background: radial-gradient(ellipse at center, #1a5f3a 0%, #0d3b24 100%);
      border-radius: 50%;
      box-shadow: 
        0 0 0 15px #8b4513,
        0 0 0 20px #654321,
        0 30px 80px rgba(0,0,0,0.8);
      border: 3px solid #2d1810;
      position: relative;
      min-height: 600px;
    }
    .seat {
      position: absolute;
    }
    .seat.pos-bottom {
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
    }
    .seat.pos-top {
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
    }
    .seat.pos-left {
      left: 5%;
      top: 50%;
      transform: translateY(-50%);
    }
    .seat.pos-right {
      right: 5%;
      top: 50%;
      transform: translateY(-50%);
    }
    .seat.pos-top-left {
      left: 15%;
      top: 15%;
    }
    .seat.pos-top-right {
      right: 15%;
      top: 15%;
    }
    .seat.pos-bottom-left {
      left: 15%;
      bottom: 20%;
    }
    .seat.pos-bottom-right {
      right: 15%;
      bottom: 20%;
    }
    .card-mini {
      width: 25px;
      height: 35px;
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      border-radius: 3px;
      border: 1px solid #1e293b;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const SUPABASE_URL = 'https://vngdiukjrfmzwlbefmjf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuZ2RpdWtqcmZtendsYmVmbWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0Njk5MDUsImV4cCI6MjA4MzA0NTkwNX0.XBr7aEzSPj-Iw0HYf27T8yXo1nbZ01MhBVa-VIdNZG4';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const CLIENT_ID_KEY = 'literature-client-id';
    function getClientId() {
      let id = localStorage.getItem(CLIENT_ID_KEY);
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem(CLIENT_ID_KEY, id);
      }
      return id;
    }

    const SETS = [
      { name: 'Spades 2-7', cards: ['2♠', '3♠', '4♠', '5♠', '6♠', '7♠'] },
      { name: 'Spades 9-A', cards: ['9♠', '10♠', 'J♠', 'Q♠', 'K♠', 'A♠'] },
      { name: 'Hearts 2-7', cards: ['2♥', '3♥', '4♥', '5♥', '6♥', '7♥'] },
      { name: 'Hearts 9-A', cards: ['9♥', '10♥', 'J♥', 'Q♥', 'K♥', 'A♥'] },
      { name: 'Clubs 2-7', cards: ['2♣', '3♣', '4♣', '5♣', '6♣', '7♣'] },
      { name: 'Clubs 9-A', cards: ['9♣', '10♣', 'J♣', 'Q♣', 'K♣', 'A♣'] },
      { name: 'Diamonds 2-7', cards: ['2♦', '3♦', '4♦', '5♦', '6♦', '7♦'] },
      { name: 'Diamonds 9-A', cards: ['9♦', '10♦', 'J♦', 'Q♦', 'K♦', 'A♦'] },
      { name: '8s + Jokers', cards: ['8♥', '8♦', '8♠', '8♣', 'RJ', 'BJ'] }
    ];

    const shuffle = deck => {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
    };

    function createBot(players) {
      let n = 1;
      while (players.some(p => p.name === `Bot ${n}`)) n++;
      return {
        id: `bot-${crypto.randomUUID()}`,
        name: `Bot ${n}`,
        hand: [],
        isBot: true
      };
    }

    const App = () => {
      const myId = useMemo(() => getClientId(), []);
      
      const [view, setView] = useState('home');
      const [roomCode, setRoomCode] = useState('');
      const [playerName, setPlayerName] = useState('');
      const [selectedTeam, setSelectedTeam] = useState('');
      const [gameData, setGameData] = useState(null);

      const [selectedOpponent, setSelectedOpponent] = useState('');
      const [selectedCard, setSelectedCard] = useState('');

      const saveGame = async (data) => {
        try {
          if (!roomCode) return;
          localStorage.setItem(`game:${roomCode}`, JSON.stringify(data));
          
          const { error } = await supabase
            .from('games')
            .upsert({ 
              room_code: roomCode, 
              game_data: data,
              updated_at: new Date().toISOString()
            });
          
          if (error) {
            console.error('Supabase save error:', error);
          }
          
          // CRITICAL: Update state immediately
          setGameData({...data});
        } catch (e) {
          console.error('saveGame error', e);
        }
      };

      const loadGame = async () => {
        if (!roomCode) return;
        try {
          const { data, error } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();
          
          if (!error && data) {
            setGameData(data.game_data);
          }
        } catch (e) {
          console.error('Load error:', e);
        }
      };

      useEffect(() => {
        if (!roomCode) return;
        loadGame();
        const interval = setInterval(loadGame, 2000);
        return () => clearInterval(interval);
      }, [roomCode]);

      const createRoom = () => {
        if (!playerName.trim()) {
          alert('Please enter your name');
          return;
        }
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        setRoomCode(code);
        setView('teamSelect');
      };

      const confirmTeamCreate = async () => {
        if (!selectedTeam) {
          alert('Please select a team');
          return;
        }

        const initialData = {
          hostId: myId,
          phase: 'lobby',
          players: [{ id: myId, name: playerName, hand: [], isBot: false }],
          teams: {
            team1: selectedTeam === 'team1' ? [myId] : [],
            team2: selectedTeam === 'team2' ? [myId] : []
          },
          currentTurn: '',
          scores: { team1: 0, team2: 0 },
          claimedSets: [],
          askHistory: [],
          gameLog: [],
          settings: {
            showAskHistory: true,
            askHistoryCount: 2,
            showCardCounts: false
          }
        };

        await saveGame(initialData);
        setView('lobby');
      };

      const joinRoom = async () => {
        if (!playerName.trim()) {
          alert('Please enter your name');
          return;
        }
        if (!roomCode.trim()) {
          alert('Please enter room code');
          return;
        }

        try {
          const { data, error } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode.toUpperCase())
            .single();

          if (error || !data) {
            alert('Room not found!');
            return;
          }

          const gameData = data.game_data;
          
          if (gameData.players.some(p => p.id === myId)) {
            setView('lobby');
            return;
          }

          setView('teamSelect');
        } catch (e) {
          alert('Error joining room');
        }
      };

      const confirmTeamJoin = async () => {
        if (!selectedTeam) {
          alert('Please select a team');
          return;
        }

        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          const gameData = data.game_data;
          gameData.players.push({ id: myId, name: playerName, hand: [], isBot: false });
          gameData.teams[selectedTeam].push(myId);
          await saveGame(gameData);
          setView('lobby');
        } catch (e) {
          alert('Error joining room');
        }
      };

      const addBot = async (team) => {
        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          if (!data) return;

          const gameData = data.game_data;
          const bot = createBot(gameData.players);
          gameData.players.push(bot);
          gameData.teams[team].push(bot.id);
          
          await saveGame(gameData);
        } catch (e) {
          console.error('Error adding bot:', e);
        }
      };

      const removePlayer = async (playerId) => {
        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          if (!data) return;

          const gameData = data.game_data;
          gameData.players = gameData.players.filter(p => p.id !== playerId);
          gameData.teams.team1 = gameData.teams.team1.filter(id => id !== playerId);
          gameData.teams.team2 = gameData.teams.team2.filter(id => id !== playerId);
          
          await saveGame(gameData);
        } catch (e) {
          console.error('Error removing player:', e);
        }
      };

      const startGame = async () => {
        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          const gameData = data.game_data;
          
          if (gameData.players.length < 4) {
            alert('Need at least 4 players to start!');
            return;
          }

          let deck = [];
          SETS.forEach(set => deck.push(...set.cards));
          shuffle(deck);

          const cardsPerPlayer = Math.floor(deck.length / gameData.players.length);
          gameData.players.forEach((p, idx) => {
            p.hand = deck.slice(idx * cardsPerPlayer, (idx + 1) * cardsPerPlayer);
          });

          gameData.phase = 'game';
          gameData.currentTurn = gameData.players[0].id;
          gameData.gameLog.unshift('Game started!');

          await saveGame(gameData);
          setView('game');
        } catch (e) {
          alert('Error starting game');
        }
      };

      const askForCard = async () => {
        if (!selectedOpponent || !selectedCard) {
          alert('Select opponent and card!');
          return;
        }

        try {
          const { data } = await supabase
            .from('games')
            .select('game_data')
            .eq('room_code', roomCode)
            .single();

          const gameData = data.game_data;
          const opponent = gameData.players.find(p => p.id === selectedOpponent);
          const me = gameData.players.find(p => p.id === myId);

          const hasCard = opponent.hand.includes(selectedCard);

          if (hasCard) {
            opponent.hand = opponent.hand.filter(c => c !== selectedCard);
            me.hand.push(selectedCard);
            gameData.gameLog.unshift(`${me.name} asked ${opponent.name} - SUCCESS!`);
            gameData.askHistory.unshift({ from: me.name, to: opponent.name, card: selectedCard, success: true });
          } else {
            gameData.currentTurn = opponent.id;
            gameData.gameLog.unshift(`${me.name} asked ${opponent.name} - FAILED`);
            gameData.askHistory.unshift({ from: me.name, to: opponent.name, card: selectedCard, success: false });
          }

          gameData.askHistory = gameData.askHistory.slice(0, 2);

          await saveGame(gameData);
          setSelectedCard('');
          setSelectedOpponent('');
        } catch (e) {
          alert('Error making move');
        }
      };

      const getPlayerPosition = (index, total) => {
        if (total <= 4) {
          return ['bottom', 'left', 'top', 'right'][index] || 'bottom';
        }
        const positions = ['bottom', 'left', 'top-left', 'top', 'top-right', 'right', 'bottom-right', 'bottom-left'];
        return positions[index] || 'bottom';
      };

      // HOME VIEW
      if (view === 'home') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4">
            <div className="bg-slate-800 rounded-3xl shadow-2xl p-8 max-w-md w-full border border-slate-700">
              <h1 className="text-5xl font-bold text-center mb-2 bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                LITERATURE
              </h1>
              <p className="text-slate-400 text-center mb-8">The Classic Card Game</p>

              <input
                type="text"
                placeholder="Your Name"
                value={playerName}
                onChange={(e) => setPlayerName(e.target.value)}
                className="w-full px-4 py-3 bg-slate-900 border-2 border-slate-700 rounded-lg mb-4 text-white focus:outline-none focus:border-yellow-500"
              />

              <button
                onClick={createRoom}
                disabled={!playerName.trim()}
                className="w-full bg-gradient-to-r from-yellow-500 to-yellow-400 text-slate-900 py-3 rounded-lg font-bold hover:from-yellow-400 hover:to-yellow-300 disabled:opacity-50 mb-4"
              >
                Create New Game
              </button>

              <div className="relative my-6">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-slate-700"></div>
                </div>
                <div className="relative flex justify-center text-sm">
                  <span className="px-2 bg-slate-800 text-slate-400">OR</span>
                </div>
              </div>

              <input
                type="text"
                placeholder="Room Code"
                value={roomCode}
                onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
                className="w-full px-4 py-3 bg-slate-900 border-2 border-slate-700 rounded-lg mb-4 text-white focus:outline-none focus:border-yellow-500"
              />

              <button
                onClick={joinRoom}
                disabled={!playerName.trim() || !roomCode.trim()}
                className="w-full bg-slate-700 text-white py-3 rounded-lg font-bold hover:bg-slate-600 disabled:opacity-50"
              >
                Join Game
              </button>
            </div>
          </div>
        );
      }

      // TEAM SELECT VIEW
      if (view === 'teamSelect') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-blue-900 flex items-center justify-center p-4">
            <div className="bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full border border-slate-700">
              <h2 className="text-2xl font-bold text-center mb-6 text-white">Choose Your Team</h2>

              <div className="space-y-4">
                <button
                  onClick={() => setSelectedTeam('team1')}
                  className={`w-full p-6 rounded-lg border-4 transition-all ${
                    selectedTeam === 'team1'
                      ? 'border-red-500 bg-red-900/30'
                      : 'border-slate-700 bg-slate-900 hover:border-red-400'
                  }`}
                >
                  <div className="text-2xl font-bold text-red-400 mb-2">Team 1</div>
                  <div className="text-sm text-slate-400">Red Team</div>
                </button>

                <button
                  onClick={() => setSelectedTeam('team2')}
                  className={`w-full p-6 rounded-lg border-4 transition-all ${
                    selectedTeam === 'team2'
                      ? 'border-blue-500 bg-blue-900/30'
                      : 'border-slate-700 bg-slate-900 hover:border-blue-400'
                  }`}
                >
                  <div className="text-2xl font-bold text-blue-400 mb-2">Team 2</div>
                  <div className="text-sm text-slate-400">Blue Team</div>
                </button>
              </div>

              <button
                onClick={gameData ? confirmTeamJoin : confirmTeamCreate}
                disabled={!selectedTeam}
                className="w-full mt-6 bg-gradient-to-r from-yellow-500 to-yellow-400 text-slate-900 py-3 rounded-lg font-bold hover:from-yellow-400 hover:to-yellow-300 disabled:opacity-50"
              >
                Confirm Team
              </button>

              <button
                onClick={() => {
                  setView('home');
                  setSelectedTeam('');
                  setRoomCode('');
                }}
                className="w-full mt-2 bg-slate-700 text-white py-2 rounded-lg font-bold hover:bg-slate-600"
              >
                Cancel
              </button>
            </div>
          </div>
        );
      }

      // LOBBY VIEW
      if (view === 'lobby' && gameData) {
        const isHost = gameData.hostId === myId;

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-blue-900 p-4">
            <div className="max-w-4xl mx-auto">
              <div className="bg-slate-800 rounded-3xl shadow-2xl p-8 border border-slate-700">
                <div className="text-center mb-6">
                  <h2 className="text-3xl font-bold mb-2 text-white">Room Code</h2>
                  <div className="text-5xl font-mono font-bold text-yellow-400 tracking-widest">{roomCode}</div>
                </div>

                <div className="grid md:grid-cols-2 gap-6 mb-6">
                  <div>
                    <h3 className="font-bold text-xl mb-3 text-red-400 text-center">
                      Team 1 ({gameData.teams.team1.length})
                    </h3>
                    {gameData.players
                      .filter(p => gameData.teams.team1.includes(p.id))
                      .map(p => (
                        <div
                          key={p.id}
                          className="bg-red-900/20 border border-red-800 px-4 py-3 rounded-lg mb-2 flex items-center justify-between"
                        >
                          <span className="text-white">
                            {p.name} {p.id === myId && '(You)'}
                          </span>
                          {isHost && p.isBot && (
                            <button
                              onClick={() => removePlayer(p.id)}
                              className="text-red-400 hover:text-red-300 text-sm"
                            >
                              Remove
                            </button>
                          )}
                        </div>
                      ))}
                    {isHost && (
                      <button
                        onClick={() => addBot('team1')}
                        className="w-full bg-red-700 text-white py-2 rounded-lg mt-2 hover:bg-red-600"
                      >
                        + Add Bot
                      </button>
                    )}
                  </div>

                  <div>
                    <h3 className="font-bold text-xl mb-3 text-blue-400 text-center">
                      Team 2 ({gameData.teams.team2.length})
                    </h3>
                    {gameData.players
                      .filter(p => gameData.teams.team2.includes(p.id))
                      .map(p => (
                        <div
                          key={p.id}
                          className="bg-blue-900/20 border border-blue-800 px-4 py-3 rounded-lg mb-2 flex items-center justify-between"
                        >
                          <span className="text-white">
                            {p.name} {p.id === myId && '(You)'}
                          </span>
                          {isHost && p.isBot && (
                            <button
                              onClick={() => removePlayer(p.id)}
                              className="text-blue-400 hover:text-blue-300 text-sm"
                            >
                              Remove
                            </button>
                          )}
                        </div>
                      ))}
                    {isHost && (
                      <button
                        onClick={() => addBot('team2')}
                        className="w-full bg-blue-700 text-white py-2 rounded-lg mt-2 hover:bg-blue-600"
                      >
                        + Add Bot
                      </button>
                    )}
                  </div>
                </div>

                {isHost && (
                  <button
                    onClick={startGame}
                    disabled={gameData.players.length < 4}
                    className="w-full bg-gradient-to-r from-yellow-500 to-yellow-400 text-slate-900 py-4 rounded-lg font-bold text-xl hover:from-yellow-400 hover:to-yellow-300 disabled:opacity-50"
                  >
                    {gameData.players.length < 4
                      ? `Waiting for ${4 - gameData.players.length} more players...`
                      : 'Start Game'}
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // GAME VIEW - POKER TABLE
      if (view === 'game' && gameData) {
        const me = gameData.players.find(p => p.id === myId);
        const myTeam = gameData.teams.team1.includes(myId) ? 'team1' : 'team2';
        const isMyTurn = gameData.currentTurn === myId;
        const currentPlayer = gameData.players.find(p => p.id === gameData.currentTurn);
        const otherPlayers = gameData.players.filter(p => p.id !== myId);

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 p-4 flex items-center justify-center">
            <div className="poker-table w-full max-w-6xl aspect-[16/10]">
              
              {/* Center Info */}
              <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                <div className="text-4xl font-bold text-yellow-400 tracking-widest mb-2">{roomCode}</div>
                <div className="text-white bg-black/50 px-4 py-2 rounded-full">
                  {isMyTurn ? "YOUR TURN" : `${currentPlayer?.name}'s Turn`}
                </div>
                <div className="text-yellow-300 mt-2">
                  Team 1: {gameData.scores.team1} | Team 2: {gameData.scores.team2}
                </div>
              </div>

              {/* Other Players */}
              {otherPlayers.map((player, idx) => {
                const position = getPlayerPosition(idx + 1, gameData.players.length);
                const playerTeam = gameData.teams.team1.includes(player.id) ? 'team1' : 'team2';
                const isActive = gameData.currentTurn === player.id;

                return (
                  <div key={player.id} className={`seat pos-${position}`}>
                    <div className={`${isActive ? 'ring-4 ring-yellow-400' : ''} bg-slate-800 border-2 ${playerTeam === 'team1' ? 'border-red-500' : 'border-blue-500'} rounded-xl p-3 text-center min-w-[140px]`}>
                      <div className="font-bold text-white">{player.name}</div>
                      <div className={`text-xs ${playerTeam === 'team1' ? 'text-red-400' : 'text-blue-400'}`}>
                        {playerTeam === 'team1' ? 'Team 1' : 'Team 2'}
                      </div>
                      <div className="text-xs text-slate-400 mt-1">{player.hand?.length || 0} cards</div>
                      <div className="flex gap-1 justify-center mt-2">
                        {Array(Math.min(player.hand?.length || 0, 5)).fill(0).map((_, i) => (
                          <div key={i} className="card-mini"></div>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })}

              {/* Your Hand Panel */}
              <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 border-2 border-slate-600 rounded-2xl p-4 max-w-[90%] shadow-2xl">
                <div className="text-sm text-slate-400 mb-2 text-center">YOUR HAND ({me?.hand?.length || 0} cards)</div>
                
                <div className="flex gap-2 flex-wrap justify-center mb-3">
                  {me?.hand?.sort().map((card, i) => {
                    const isRed = card.includes('♥') || card.includes('♦');
                    return (
                      <div
                        key={i}
                        onClick={() => {
                          if (!isMyTurn) {
                            alert('Not your turn!');
                            return;
                          }
                          setSelectedCard(selectedCard === card ? '' : card);
                        }}
                        className={`
                          w-16 h-24 bg-white rounded-lg flex items-center justify-center text-2xl font-bold cursor-pointer
                          transition-all hover:scale-105
                          ${isRed ? 'text-red-600' : 'text-black'}
                          ${selectedCard === card ? 'ring-4 ring-yellow-400 scale-110' : ''}
                        `}
                      >
                        {card}
                      </div>
                    );
                  })}
                </div>

                {isMyTurn && (
                  <div className="flex gap-2 flex-wrap justify-center">
                    <select
                      value={selectedOpponent}
                      onChange={(e) => setSelectedOpponent(e.target.value)}
                      className="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm"
                    >
                      <option value="">Select Opponent</option>
                      {gameData.players
                        .filter(p => 
                          p.id !== myId && 
                          gameData.teams[myTeam === 'team1' ? 'team2' : 'team1'].includes(p.id)
                        )
                        .map(p => (
                          <option key={p.id} value={p.id}>{p.name}</option>
                        ))}
                    </select>
                    
                    <button
                      onClick={askForCard}
                      disabled={!selectedCard || !selectedOpponent}
                      className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-400 text-slate-900 rounded-lg font-bold text-sm hover:from-yellow-400 hover:to-yellow-300 disabled:opacity-50"
                    >
                      Ask for Card
                    </button>
                    
                    <button
                      onClick={() => alert('Call set feature coming soon')}
                      className="px-4 py-2 bg-slate-700 text-white rounded-lg font-bold text-sm hover:bg-slate-600"
                    >
                      Call Set
                    </button>
                  </div>
                )}

                {!isMyTurn && (
                  <div className="text-center text-slate-400 text-sm">
                    Waiting for {currentPlayer?.name}...
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      return null;
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
